# 2026-02-12 세션 작업 기록

- 세션 일시: 2026-02-12 (KST)
- 작업 저장소: `/Users/shlee/Desktop/coding_test_prep_ver3`
- 기준 커밋: `9533d17` (`Stabilize internal release pipeline for always-on API and EAS preview`)

## 1) 이번 세션에서 수행한 핵심 작업

### 배포 구조/인프라
- API를 serverless가 아닌 always-on 배포 전제로 정리
  - 추가: `Dockerfile.backend`, `render.yaml`, `.dockerignore`
- Vercel을 정적 웹 배포 전용으로 정리
  - 수정: `vercel.json`
  - 추가: `.vercelignore`
- 내부 릴리즈 체크리스트 문서화
  - 추가: `docs/internal-release-checklist.md`

### 환경변수/설정 강화
- production 서버 필수 환경변수 검증 강화
  - `DATABASE_URL`, `JWT_SECRET`, `ALLOWED_ORIGINS`
- EAS preview/production 빌드 필수값 강제
  - `EXPO_PUBLIC_API_BASE_URL`, `EAS_PROJECT_ID`
- 관련 파일
  - 수정: `server/_core/env.ts`, `app.config.ts`, `.env.example`, `eas.json`, `constants/oauth.ts`

### 서버 헬스체크/운영성
- `/api/health` 응답에 의존성 상태 포함
  - `database.configured`, `database.reachable`, `redis.enabled`
- production에서 DB 비정상이면 503 응답하도록 반영
- 관련 파일
  - 수정: `server/_core/index.ts`, `server/db.ts`

### 기능 보완
- 추천 API에 `excludeSolved?: boolean` 반영
  - 서버 필터 + 클라이언트 전달 로직 적용
- 분석 탭 mock 중심 구현을 실데이터 기반으로 교체
- 관련 파일
  - 수정: `server/routers.ts`, `app/(tabs)/recommendations.tsx`, `app/(tabs)/analytics.tsx`
  - 테스트 추가: `server/__tests__/recommendations.list.test.ts`

### 보안/로그 정리
- 민감한 인증/세션 로그를 개발 환경 중심으로 축소
- DB 생성 스크립트의 하드코딩 비밀번호 제거
- 관련 파일
  - 추가: `lib/_core/logger.ts`
  - 수정: `lib/_core/api.ts`, `lib/_core/auth.ts`, `hooks/use-auth.ts`, `server/_core/sdk.ts`, `scripts/create-db.js`

### CI
- PR/Push에서 `check/lint/test/build` 수행하는 워크플로 추가
  - 추가: `.github/workflows/ci.yml`

### 빌드 산출물 충돌 이슈 수정
- `pnpm build`와 `pnpm build:web`가 동일 `dist/`를 공유하던 문제 해결
  - 서버 빌드 출력 경로를 `dist-server/`로 분리
  - 수정: `package.json`, `.gitignore`, `DEPLOY.md`

### 스모크 도구 추가
- API 기본 스모크 테스트 스크립트 추가
  - 추가: `scripts/smoke-api.mjs`
  - 스크립트: `pnpm smoke:api <api-base-url>`

## 2) 검증 결과

다음 항목을 재실행하여 통과 확인:
- `pnpm check` ✅
- `pnpm lint` ✅ (에러 0, 경고 10)
- `pnpm test` ✅ (37/37)
- `pnpm build` ✅
- `EXPO_PUBLIC_API_BASE_URL=https://api.example.com pnpm build:web` ✅

헬스체크 동작 검증:
- dev + DB 비가용: `/api/health` -> HTTP 200 (`ok: true`, `database.reachable: false`) ✅
- production + DB 비가용: `/api/health` -> HTTP 503 (`ok: false`) ✅

API 스모크 검증:
- `pnpm smoke:api http://127.0.0.1:4012` -> `/api/health`, `/api/auth/providers` PASS ✅

## 3) 커밋/워크트리 상태

- 커밋 완료: `9533d17`
- 커밋 제외 항목: `.claude/settings.local.json` (로컬 설정 파일)
- 현재 미커밋 변경: `.claude/settings.local.json`만 존재

## 4) 외부 서비스 단계 진행 결과 (인증 필요로 보류)

실행 시도 및 결과:
- `git push origin main` -> `Permission denied (publickey)`
- `npx eas-cli whoami` -> `Not logged in`
- `npx eas-cli build --profile preview --platform ios --non-interactive` -> Expo 계정 필요
- `npx vercel whoami` -> Vercel credentials 없음
- `render` CLI -> 설치/명령 없음

즉, 코드/로컬 검증은 완료되었고, 실제 배포/배포 계정 연동 단계는 계정 인증 후 진행 필요.

## 5) 다음 실행 권장 순서

1. Git 인증 설정 후 `git push origin main`
2. Expo 로그인 후 preview 빌드 실행
   - `eas login`
   - `eas build --profile preview --platform ios`
   - `eas build --profile preview --platform android`
3. Vercel/Render 로그인 후 배포 연결
4. 운영 API URL로 `pnpm smoke:api https://<api-domain>` 실행
5. 내부 테스터 대상 E2E 리허설 (로그인 → 동기화 → 추천/분석 → 로그아웃)
